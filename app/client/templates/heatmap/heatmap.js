subfam2id = {"L2a":1,"AluSx":2,"AluY":3,"AluJb":4,"MIRb":5,"AluSx1":6,"AluSz":7,"L2c":8,"MIR":9,"L1PA7":10,"L1PA3":11,"L1PA4":12,"AluJr":13,"L2b":14,"L1M5":15,"AluJo":16,"AluSq2":17,"L1PA5":18,"L2":19,"L1ME1":20,"AluSp":21,"MIRc":22,"L1PB1":23,"AluSg":24,"AluSz6":25,"L1PA6":26,"L1PA16":27,"L1MB7":28,"MIR3":29,"AluSc":30,"L1PA2":31,"L1ME4a":32,"L1MC4":33,"HAL1":34,"Tigger1":35,"AT_rich":36,"L1MEc":37,"L1MC4a":38,"L1M1":39,"L3":40,"L1MA3":41,"AluSx3":42,"L1PA15":43,"L1MA9":44,"L1MC1":45,"L1PA13":46,"ALR/Alpha":47,"THE1B":48,"L1MA2":49,"L1MC3":50,"L1MB8":51,"L1MEg":52,"L1M4":53,"L1MB3":54,"L1PA8":55,"L1PA10":56,"L1MEf":57,"MLT1D":58,"(TA)n":59,"AluSq":60,"L1PREC2":61,"MSTA":62,"AluSc8":63,"L1MA4":64,"MLT1C":65,"L1ME3A":66,"MLT1A0":67,"L1ME2":68,"HERVH-int":69,"L1MA8":70,"L1MC5":71,"L1M2":72,"L1MA4A":73,"L1MD2":74,"THE1B-int":75,"MLT1B":76,"MER5A":77,"AluJr4":78,"L1MA1":79,"L1MEe":80,"L1MCa":81,"MLT1K":82,"L1MD1":83,"L1MA7":84,"L1PB4":85,"L1ME3C":86,"L1PA11":87,"THE1D":88,"L1MDa":89,"L1MB5":90,"ERVL-E-int":91,"ERV3-16A3_I-int":92,"HERVL-int":93,"MLT1J":94,"L1MB4":95,"LTR12C":96,"L1MB2":97,"L1M4c":98,"L4":99,"L1MEd":100,"L1HS":101,"L1ME3":102,"L1MA6":103,"L1MC2":104,"THE1C":105,"L1MB1":106,"L1PA8A":107,"Tigger3b":108,"L1PA17":109,"L1M4b":110,"(CA)n":111,"(TG)n":112,"L1MC":113,"MER20":114,"MSTA-int":115,"L1ME3B":116,"MER5B":117,"L1PA14":118,"L1MA5":119,"L1PB3":120,"FLAM_C":121,"MLT1H":122,"MSTB":123,"L1P1":124,"L1MD":125,"ERVL-B4-int":126,"L1P3":127,"MLT1L":128,"L1PBa":129,"MLT1A":130,"L1ME2z":131,"LTR33":132,"MER58A":133,"MLT1I":134,"L1M3":135,"MER21C":136,"AluSg7":137,"L1PB2":138,"Charlie1a":139,"MSTD":140,"L1P2":141,"MER2":142,"AluSg4":143,"MLT1F2":144,"L1M6":145,"MER5A1":146,"THE1C-int":147,"THE1D-int":148,"LTR16A":149,"MLT1A1":150,"MER52A":151,"AluSc5":152,"FLAM_A":153,"SVA_D":154,"MER33":155,"HERV9-int":156,"L1MA5A":157,"L1MD3":158,"LTR16C":159,"L1ME3E":160,"THE1A-int":161,"L1MA10":162,"MER4-int":163,"L1ME3D":164,"L1P4":165,"L1ME3F":166,"MSTB1":167,"Tigger2":168,"AluSx4":169,"MER3":170,"MER1B":171,"LTR8":172,"MLT2A2":173,"CT-rich":174,"GA-rich":175,"MLT1J2":176,"Tigger3a":177,"L1M7":178,"L1PA12":179,"MLT1E2":180,"L1PA15-16":181,"L1MCc":182,"BSR/Beta":183,"MER1A":184,"LTR78":185,"MER58B":186,"MLT1F":187,"MER103C":188,"MLT2B1":189,"THE1A":190,"LTR8A":191,"MLT2B4":192,"HAL1b":193,"MER21B":194,"MLT2B3":195,"AluYc":196,"MER41-int":197,"FRAM":198,"MLT1G1":199,"AluYa5":200,"MLT1H1":201,"MER82":202,"L1MCb":203,"MLT1E1A":204,"MER50":205,"MLT2D":206,"HSMAR2":207,"MER39":208,"MLT1N2":209,"MER61-int":210,"LTR49-int":211,"MER41B":212,"L1ME5":213,"MLT2A1":214,"A-rich":215,"G-rich":216,"MLT1J1":217,"T-rich":218,"Charlie7":219,"Tigger2a":220,"C-rich":221,"MLT1H2":222,"HERVK9-int":223,"MLT1F1":224,"MER41A":225,"MER20B":226,"Charlie2b":227,"LTR7":228,"Tigger15a":229,"MER57A-int":230,"MER57-int":231,"SATR1":232,"L1PB":233,"LTR9":234,"L3b":235,"MSTC":236,"MER11A":237,"MLT1G":238,"LTR1":239,"MamRep605":240,"HERV17-int":241,"Tigger13a":242,"MER11C":243,"MLT1G3":244,"MSTB-int":245,"BLACKJACK":246,"Charlie4a":247,"Harlequin-int":248,"LTR79":249,"AluYb8":250,"MER4A1":251,"HERV16-int":252,"SVA_F":253,"MER31-int":254,"MER113":255,"MER102b":256,"Tigger4":257,"MER30":258,"MER47A":259,"Arthur1":260,"FAM":261,"LTR16A1":262,"MER53":263,"Tigger7":264,"MER4B-int":265,"LTR67B":266,"LTR78B":267,"MER21A":268,"LOR1-int":269,"LTR50":270,"LTR1B":271,"MER115":272,"LTR1D":273,"MER4B":274,"MLT2B2":275,"Charlie4z":276,"MER4D1":277,"Zaphod":278,"MLT1E3":279,"MER112":280,"LTR40a":281,"Charlie1b":282,"LTR16E2":283,"MER44B":284,"LTR16E1":285,"Tigger4a":286,"L1P4a":287,"L1MEb":288,"Charlie2a":289,"Charlie1":290,"L1M3c":291,"MLT2C1":292,"HERVIP10F-int":293,"MLT2F":294,"Tigger4b":295,"MER63A":296,"MARNA":297,"Arthur1B":298,"HUERS-P3-int":299,"MER117":300,"Plat_L3":301,"MER46C":302,"MER74A":303,"Charlie5":304,"L1M3f":305,"MER102c":306,"MER52D":307,"L1PBa1":308,"MER44A":309,"(TGGA)n":310,"Tigger2b_Pri":311,"Charlie8":312,"HERVK22-int":313,"GC_rich":314,"LTR5_Hs":315,"SVA_B":316,"MER101-int":317,"LTR25-int":318,"MSTD-int":319,"MER21-int":320,"MER68":321,"MER4D":322,"MLT1A0-int":323,"MER49":324,"CER":325,"MER65-int":326,"AluYk4":327,"MSTB2":328,"Tigger3c":329,"(TCCA)n":330,"HERVE-int":331,"MER67C":332,"AluSq10":333,"LTR12":334,"LTR33A":335,"L1M3e":336,"MER52-int":337,"MER11B":338,"LTR16A2":339,"HERVL40-int":340,"MER94":341,"MER66-int":342,"MER102a":343,"MER77B":344,"LTR41":345,"LTR39":346,"HERVIP10FH-int":347,"MER77":348,"LTR16B2":349,"HERVK-int":350,"MADE1":351,"LTR17":352,"MER45B":353,"L1M2a":354,"L1MDb":355,"(TAGA)n":356,"Tigger3":357,"MER45A":358,"(TCTA)n":359,"HSMAR1":360,"LTR49":361,"MER31B":362,"MLT1M":363,"ERVL-int":364,"MER63B":365,"LTR37B":366,"LTR33A_":367,"(GAATG)n":368,"MER39B":369,"MER91A":370,"HUERS-P1-int":371,"(TATATG)n":372,"LTR37A":373,"MLT1J-int":374,"(CATATA)n":375,"MER31A":376,"MER4A":377,"MER66B":378,"Charlie15a":379,"(GAAA)n":380,"(TTTC)n":381,"MER89":382,"MER4E1":383,"MamRep137":384,"HUERS-P3b-int":385,"HERV3-int":386,"MER65A":387,"MER44C":388,"Kanga2_a":389,"Charlie18a":390,"LTR12D":391,"L1M3b":392,"HERVL18-int":393,"MER90a":394,"MER51A":395,"MER50-int":396,"MER34A":397,"Charlie25":398,"MER4C":399,"LTR13":400,"AluSq4":401,"(A)n":402,"(GA)n":403,"(T)n":404,"(TC)n":405,"LTR16B1":406,"Tigger6a":407,"SVA_C":408,"HERVS71-int":409,"MER51-int":410,"(CATTC)n":411,"HERVK11-int":412,"HERVK3-int":413,"LOR1b":414,"Cheshire":415,"MER57A1":416,"HERV35I-int":417,"MER6A":418,"MER6":419,"SST1":420,"MamRep434":421,"LTR48":422,"LTR32":423,"LTR48B":424,"MER8":425,"MER58C":426,"AluYf4":427,"LTR85a":428,"MER63C":429,"HERVE_a-int":430,"L1M2c":431,"MamRep38":432,"MER34":433,"LTR2":434,"MLT1A1-int":435,"CR1_Mam":436,"LTR33B":437,"PRIMA4-int":438,"MER81":439,"PRIMA41-int":440,"MER4E":441,"LTR5B":442,"LTR82A":443,"LTR82B":444,"MER45C":445,"MER96B":446,"Tigger5":447,"SATR2":448,"MER72":449,"MLT2C2":450,"MamRep1527":451,"MER89-int":452,"LTR40b":453,"MER50B":454,"L1PBb":455,"MER67D":456,"Charlie10":457,"L1M3a":458,"MLT1E1":459,"MER119":460,"MLT1H-int":461,"(TTA)n":462,"(TAA)n":463,"LTR28":464,"HERVI-int":465,"MER74B":466,"MER54A":467,"LTR7B":468,"LTR12B":469,"MER52C":470,"MER104":471,"MER57B1":472,"LOR1a":473,"LTR12_":474,"FordPrefect":475,"LTR9B":476,"L1M3d":477,"PABL_A-int":478,"Charlie16a":479,"MER57B2":480,"LTR84b":481,"MLT1D-int":482,"Ricksha_c":483,"MLT1I-int":484,"L1MEg1":485,"LTR88b":486,"L1M3de":487,"SVA_A":488,"(TTATA)n":489,"LTR54":490,"(TATAA)n":491,"Charlie3":492,"LTR41B":493,"MamRep1161":494,"LTR52":495,"Charlie24":496,"HSATII":497,"HERVP71A-int":498,"MER63D":499,"ERV3-16A3_LTR":500,"MER76":501,"Charlie19a":502,"MLT1E":503,"(CATA)n":504,"LTR56":505,"7SLRNA":506,"LTR16D":507,"MER47B":508,"MER9a3":509,"LTR81B":510,"HERVK14-int":511,"MER92B":512,"MER41C":513,"(TATG)n":514,"LTR27B":515,"HERVL74-int":516,"L1MEg2":517,"MamGypLTR1b":518,"LTR85b":519,"MER113A":520,"(TTCC)n":521,"(GGAA)n":522,"LTR12F":523,"MER2B":524,"LTR5A":525,"MER5C":526,"PABL_A":527,"LTR26":528,"LTR33C":529,"MamGypLTR1a":530,"HAL1-2a_MD":531,"MER61A":532,"MamGypLTR1c":533,"Zaphod3":534,"Charlie7a":535,"HERV4_I-int":536,"LTR54B":537,"Charlie23a":538,"LTR53":539,"LTR10C":540,"GSAT":541,"SVA_E":542,"LTR85c":543,"Tigger10":544,"HSAT4":545,"MamSINE1":546,"MER34B-int":547,"LTR47A":548,"MER44D":549,"Tigger9b":550,"MLT1J2-int":551,"LTR89":552,"HUERS-P2-int":553,"LTR27":554,"MER90":555,"MER34A1":556,"PRIMAX-int":557,"Charlie9":558,"Helitron3Na_Mam":559,"HAL1-3A_ME":560,"MamGypLTR2c":561,"LTR57-int":562,"Kanga1a":563,"MER34B":564,"Tigger8":565,"MER65C":566,"MER51B":567,"HERVH48-int":568,"LTR81A":569,"MLT1B-int":570,"Tigger12c":571,"MamRep4096":572,"LTR29":573,"Charlie20a":574,"Charlie21a":575,"(TTTA)n":576,"MLT1C-int":577,"LTR16B":578,"MER70A":579,"(TAAA)n":580,"LTR87":581,"ORSL":582,"MamGypLTR3":583,"MLT1J1-int":584,"GSATII":585,"MLT1F-int":586,"Tigger9a":587,"MamRep1879":588,"LTR40c":589,"Ricksha_0":590,"MER11D":591,"MER34C_":592,"Charlie22a":593,"Charlie17a":594,"MER110":595,"MADE2":596,"MLT1A-int":597,"MER4A1_":598,"PABL_B-int":599,"(TGAA)n":600,"(TTCA)n":601,"LTR10F":602,"LTR36":603,"MER110-int":604,"MSTB1-int":605,"Kanga11a":606,"Tigger14a":607,"Kanga1":608,"Looper":609,"MER75":610,"LTR83":611,"Charlie13a":612,"MLT1H1-int":613,"LTR81C":614,"LTR23":615,"REP522":616,"LTR22C":617,"MER121":618,"LTR51":619,"MER54B":620,"THE1-int":621,"(TTG)n":622,"MER45R":623,"MER34C2":624,"MER34-int":625,"LTR14B":626,"MER70-int":627,"MER67B":628,"MER9a1":629,"MER110A":630,"MER91B":631,"MER4D0":632,"LTR88c":633,"(TTTTG)n":634,"L1M2b":635,"(CAA)n":636,"LTR18B":637,"AluYg6":638,"LFSINE_Vert":639,"MER66C":640,"MamGypLTR2b":641,"LTR19A":642,"(CAAAA)n":643,"AmnSINE1":644,"LTR19-int":645,"LTR80B":646,"HERV15-int":647,"Arthur1A":648,"LTR88a":649,"ORSL-2b":650,"Kanga1c":651,"L5":652,"MER70B":653,"MER68-int":654,"MER83":655,"LTR43":656,"MSTC-int":657,"HERVFH21-int":658,"MER58D":659,"U6":660,"(TTTG)n":661,"LTR13A":662,"MER83B-int":663,"LTR55":664,"L1P4e":665,"LTR2B":666,"(CAAA)n":667,"MER68B":668,"Zaphod2":669,"LTR84a":670,"L1P4b":671,"MLT1H2-int":672,"PRIMA4_LTR":673,"MLT1G1-int":674,"MER9a2":675,"LTR40A1":676,"LTR26B":677,"MER106B":678,"MER96":679,"AluYc3":680,"Tigger16b":681,"PABL_B":682,"MER41D":683,"LTR45B":684,"MamGypLTR1d":685,"LTR10A":686,"L1P4d":687,"MER61B":688,"LTR47B":689,"MER57C2":690,"LTR24B":691,"MER91C":692,"LTR34":693,"LTR45C":694,"MER41E":695,"MST-int":696,"MER106A":697,"L1MEa":698,"MLT1F2-int":699,"LTR52-int":700,"(TGG)n":701,"LTR62":702,"MER57E1":703,"(TCTCTG)n":704,"LTR6A":705,"LTR86A1":706,"(CCA)n":707,"HERV30-int":708,"MER57D":709,"HERVK14C-int":710,"LTR80A":711,"MER61E":712,"Kanga1d":713,"LTR65":714,"LTR7C":715,"HERVFH19-int":716,"LTR25":717,"MER57F":718,"MLT-int":719,"MER124":720,"Charlie6":721,"LTR10E":722,"L1M2a1":723,"LTR24C":724,"MER67A":725,"LTR19B":726,"(CAGAGA)n":727,"Mam_R4":728,"LTR38":729,"7SK":730,"L1P5":731,"LTR26E":732,"MER65D":733,"X7A_LINE":734,"Ricksha":735,"X7B_LINE":736,"Tigger12A":737,"MER6B":738,"MER66A":739,"MamRep564":740,"MER73":741,"LTR1C":742,"MER85":743,"HERV1_I-int":744,"(ATG)n":745,"MER61C":746,"LTR42":747,"MER101":748,"LTR64":749,"L1M":750,"(TTTTA)n":751,"(CAT)n":752,"LTR66":753,"(TAAAA)n":754,"LTR46-int":755,"MER105":756,"MLT1G3-int":757,"Tigger16a":758,"Arthur1C":759,"MER97a":760,"LTR22B":761,"GSATX":762,"MER84":763,"Tigger12":764,"LTR68":765,"LTR15":766,"LTR31":767,"LTR71B":768,"LTR12E":769,"Tigger11a":770,"MER70C":771,"MER5C1":772,"MER99":773,"MER61D":774,"MamGyp-int":775,"Kanga1b":776,"LTR75":777,"AluYb9":778,"LTR76":779,"MLT2E":780,"LTR24":781,"MLT2B5":782,"MER84-int":783,"5S":784,"LTR7Y":785,"MER113B":786,"TAR1":787,"LTR2C":788,"LTR30":789,"LTR70":790,"MSR1":791,"MER34D":792,"LTR38B":793,"Charlie14a":794,"LTR73":795,"HERVK11D-int":796,"(CGGGG)n":797,"LTR19C":798,"LTR3B_":799,"Charlie13b":800,"LTR57":801,"Helitron1Nb_Mam":802,"MLT1G-int":803,"LTR10D":804,"LTR90B":805,"LTR43-int":806,"AluYk11":807,"HERVK13-int":808,"Helitron1Na_Mam":809,"MER135":810,"LSU-rRNA_Hsa":811,"LTR60":812,"HERVL66-int":813,"LTR16D2":814,"MER76-int":815,"Charlie26a":816,"Tigger6b":817,"LTR86C":818,"LTR18A":819,"LTR46":820,"LTR10B1":821,"LTR23-int":822,"MLT1F1-int":823,"LTR6B":824,"Tigger3d":825,"MERX":826,"LTR22A":827,"LTR43B":828,"X7C_LINE":829,"(CCG)n":830,"MER101B":831,"MSTB2-int":832,"X3_LINE":833,"MER74C":834,"MER87B":835,"(TCCC)n":836,"(CCCCG)n":837,"MER97c":838,"(CGG)n":839,"MER66D":840,"Ricksha_b":841,"LTR86A2":842,"MER51E":843,"MER51C":844,"ORSL-2a":845,"MER72B":846,"HERVL32-int":847,"(GGGA)n":848,"HERVKC4-int":849,"(TTAA)n":850,"LTR14C":851,"MER48":852,"MER61F":853,"LTR86B1":854,"LTR90A":855,"(TGGG)n":856,"LTR61":857,"LTR44":858,"LTR81":859,"(TCC)n":860,"MamRep1894":861,"MER87":862,"(TGAG)n":863,"(AAATG)n":864,"Helitron2Na_Mam":865,"LTR3A":866,"(CCCA)n":867,"LTR86B2":868,"LTR71A":869,"(GAA)n":870,"LTR77":871,"MLT1-int":872,"(TTC)n":873,"LTR75B":874,"MER83A-int":875,"(CACCAT)n":876,"MamRep488":877,"polypurine":878,"MER97b":879,"MLT1E2-int":880,"FordPrefect_a":881,"LTR35B":882,"LTR16D1":883,"ALINE":884,"(ATGGTG)n":885,"polypyrimidine":886,"LTR39-int":887,"MER47C":888,"(CAAAAA)n":889,"(TTTTC)n":890,"(GAAAA)n":891,"MER94B":892,"(GGA)n":893,"(TTTTTG)n":894,"(CAGC)n":895,"LTR72":896,"MER92C":897,"LTR69":898,"(CTCA)n":899,"LTR72B":900,"LTR45":901,"AluYf5":902,"LTR10G":903,"MER57C1":904,"AluYd8":905,"(TTAGGG)n":906,"(CATTT)n":907,"(CCCTAA)n":908,"Tigger1a_Art":909,"MER107":910,"LTR22":911,"LTR38C":912,"U2":913,"MER57E3":914,"Charlie10a":915,"(CCCCAG)n":916,"HY3":917,"L1P3b":918,"LTR4":919,"X6B_LINE":920,"LTR14":921,"(TCCCC)n":922,"MER97d":923,"LTR81AB":924,"ACRO1":925,"MER83C":926,"MER65B":927,"MER131":928,"MLT1K-int":929,"UCON29":930,"MER41G":931,"HY1":932,"(GGGGA)n":933,"Charlie10b":934,"AluYa8":935,"(CTGGGG)n":936,"MLT1E1A-int":937,"LTR14A":938,"MER34C":939,"(CAG)n":940,"LTR75_1":941,"MER95":942,"LTR59":943,"Charlie11":944,"LTR35":945,"(CATG)n":946,"X8_LINE":947,"(CTG)n":948,"(GGGTG)n":949,"MER92A":950,"LTR13_":951,"AluYk12":952,"LTR38-int":953,"LTR21A":954,"D20S16":955,"MER51D":956,"(CACCC)n":957,"MER83B":958,"(GCTG)n":959,"(CTA)n":960,"LTR3":961,"LTR3B":962,"MER88":963,"MER127":964,"(TAG)n":965,"MER50C":966,"(CAGA)n":967,"LSAU":968,"PrimLTR79":969,"LTR10B":970,"HSAT5":971,"(CCCTAG)n":972,"MER30B":973,"MLT1E3-int":974,"(CTAGGG)n":975,"LTR35A":976,"U13_":977,"X6A_LINE":978,"(CGTG)n":979,"UCON26":980,"(GTGTG)n":981,"MER126":982,"AluYh9":983,"Eulor8":984,"DNA1_Mam":985,"(TCTG)n":986,"(GAGTG)n":987,"MLT1L-int":988,"LTR58":989,"(CACG)n":990,"U1":991,"HERV-Fc1-int":992,"(CAGCC)n":993,"(CTATA)n":994,"UCON28a":995,"(TCTCCC)n":996,"U3":997,"Charlie4":998,"(TAAAAA)n":999,"Ricksha_a":1000,"(GGGAA)n":1001,"(TATAG)n":1002,"(GGGAGA)n":1003,"(CACAC)n":1004,"(TTCCC)n":1005,"SSU-rRNA_Hsa":1006,"UCON27":1007,"(TTTTTA)n":1008,"MER6C":1009,"MER129":1010,"X1_LINE":1011,"MER57E2":1012,"BC200":1013,"LTR21B":1014,"AmnSINE2":1015,"(ATTG)n":1016,"MLT1N2-int":1017,"HSATI":1018,"L1P4c":1019,"(TTGG)n":1020,"MER75B":1021,"(CAAT)n":1022,"Eulor5A":1023,"MER130":1024,"UCON7":1025,"(CCTTG)n":1026,"Merlin1_HS":1027,"UCON31":1028,"(CCAA)n":1029,"(GGAAA)n":1030,"U13":1031,"Tigger2b":1032,"(GGCTG)n":1033,"MER9B":1034,"UCON4":1035,"MER125":1036,"MLT1E1-int":1037,"Eulor9A":1038,"(CCTG)n":1039,"UCON2":1040,"Tigger1a_Mars":1041,"(TTAAA)n":1042,"X5A_LINE":1043,"(CCTA)n":1044,"(TTTCC)n":1045,"(CATAT)n":1046,"(TTGGGG)n":1047,"UCON8":1048,"U4":1049,"(CACTC)n":1050,"(TAGG)n":1051,"HERV1_LTRc":1052,"UCON28b":1053,"L1P":1054,"(TTTAA)n":1055,"UCON5":1056,"(CAGG)n":1057,"(TCTCC)n":1058,"U7":1059,"(CCCCAA)n":1060,"UCON6":1061,"Eulor1":1062,"(CTATT)n":1063,"HY4":1064,"UCON28c":1065,"(GGAGA)n":1066,"(CATCC)n":1067,"Eulor6D":1068,"HERV-Fc2-int":1069,"UCON10":1070,"U5":1071,"(CATCT)n":1072,"Eulor11":1073,"HERV1_LTRa":1074,"(ATATG)n":1075,"(AGATG)n":1076,"UCON14":1077,"X2_LINE":1078,"(CACCT)n":1079,"Eulor6B":1080,"UCON13":1081,"(AATAG)n":1082,"HERV1_LTRe":1083,"(TTATG)n":1084,"(TATTG)n":1085,"(GGATG)n":1086,"(AGGTG)n":1087,"Eulor2A":1088,"(GAGAA)n":1089,"Eulor9C":1090,"(TGGGGG)n":1091,"UCON20":1092,"(CCCCCA)n":1093,"(CGCGG)n":1094,"Eulor2B":1095,"(TTCTCC)n":1096,"UCON11":1097,"UCON9":1098,"(CG)n":1099,"MER134":1100,"(CCGCG)n":1101,"(GGAGAA)n":1102,"(CATAA)n":1103,"(TTCTC)n":1104,"(GTTTG)n":1105,"X5B_LINE":1106,"(CACAG)n":1107,"Charlie12":1108,"(CAAAC)n":1109,"(CAGCT)n":1110,"(CAATA)n":1111,"tRNA-Cys-TGY":1112,"(AGGGGG)n":1113,"(CCCCCT)n":1114,"UCON15":1115,"(CGGGGG)n":1116,"X9_LINE":1117,"HERV1_LTRd":1118,"MER75A":1119,"MER123":1120,"(CCCCCG)n":1121,"Eulor4":1122,"Eulor12":1123,"tRNA-Glu-GAG_":1124,"(CACAA)n":1125,"MLT1E-int":1126,"UCON17":1127,"(CAGT)n":1128,"tRNA-Glu-GAA":1129,"HERV-Fc1_LTR1":1130,"(CCCTG)n":1131,"(CAAG)n":1132,"(TTGTG)n":1133,"tRNA-Ala-GCY_":1134,"UCON12":1135,"(TTAG)n":1136,"(CAATT)n":1137,"Eulor3":1138,"tRNA-Phe-TTY":1139,"AluYc5":1140,"(CACTA)n":1141,"UCON16":1142,"(TCCTG)n":1143,"Eulor5B":1144,"(TCCG)n":1145,"(CTGTG)n":1146,"UCON19":1147,"MER136":1148,"(CCTAT)n":1149,"(CACAT)n":1150,"(CTTG)n":1151,"(GTCTG)n":1152,"SAR":1153,"tRNA-Gly-GGA":1154,"(TTCGGG)n":1155,"Eulor10":1156,"HERV1_LTRb":1157,"LTR5":1158,"(TAGTG)n":1159,"Eulor2C":1160,"UCON22":1161,"MER133A":1162,"X7D_LINE":1163,"Eulor6E":1164,"(AATTG)n":1165,"tRNA-Gln-CAG":1166,"(CAGGG)n":1167,"(CAGGC)n":1168,"MER132":1169,"(CTAG)n":1170,"(CACCG)n":1171,"Eulor6A":1172,"HSAT6":1173,"(CATTA)n":1174,"(CGGA)n":1175,"tRNA-Lys-AAG":1176,"UCON12A":1177,"(CAGGA)n":1178,"(TTCTG)n":1179,"UCON23":1180,"UCON21":1181,"UCON25":1182,"(CAACT)n":1183,"(CTAA)n":1184,"(CACGC)n":1185,"(CATAC)n":1186,"MER133B":1187,"(CTTA)n":1188,"UCON1":1189,"UCON24":1190,"U8":1191,"tRNA-Asn-AAC":1192,"(CTATG)n":1193,"(GGTTG)n":1194,"tRNA-Lys-AAA":1195,"UCON18":1196,"(CGAAT)n":1197,"(CTACT)n":1198,"(GCGTG)n":1199,"(CAGTG)n":1200,"SUBTEL_sa":1201,"(C)n":1202,"tRNA-Met":1203,"(ATGTG)n":1204,"(TAAG)n":1205,"(G)n":1206,"tRNA-Ile-ATA":1207,"(ACTG)n":1208,"Eulor9B":1209,"tRNA-Gly-GGG":1210,"tRNA-Ile-ATT":1211,"(GCCTG)n":1212,"(TTTAG)n":1213,"tRNA-Ala-GCA":1214,"Eulor6C":1215,"tRNA-His-CAY_":1216,"(TAATG)n":1217,"tRNA-Asp-GAY":1218,"(CAGAA)n":1219,"(CATAG)n":1220,"(CGAGG)n":1221,"tRNA-Met_":1222,"tRNA-Met-i":1223,"(CAGTA)n":1224,"tRNA-Gln-CAA_":1225,"HERV-Fc1_LTR3":1226,"(CTAAA)n":1227,"tRNA-Val-GTG":1228,"(CAACC)n":1229,"tRNA-Leu-CTY":1230,"(GTATG)n":1231,"(AGCTG)n":1232,"(CTTTA)n":1233,"(CGAG)n":1234,"tRNA-Arg-CGY_":1235,"(CCTCG)n":1236,"(CGGG)n":1237,"(ATAAG)n":1238,"(TAAAG)n":1239,"(CTCTG)n":1240,"LTR7A":1241,"tRNA-Tyr-TAC":1242,"(CAGAG)n":1243,"tRNA-Leu-TTG":1244,"tRNA-Ser-TCA(m)":1245,"tRNA-Gly-GGY":1246,"(CAGTC)n":1247,"(CCCG)n":1248,"tRNA-Ala-GCY":1249,"(ATAGG)n":1250,"Cheshire_Mars_":1251,"tRNA-Leu-TTA(m)":1252,"(CCCGG)n":1253,"tRNA-Arg-AGA":1254,"(CTTTG)n":1255,"LTR11":1256,"(CGGTG)n":1257,"(AAGTG)n":1258,"(CTCG)n":1259,"(ACATG)n":1260,"(TACTG)n":1261,"(CAAAG)n":1262,"(CATGT)n":1263,"(CTTAT)n":1264,"(CTAAT)n":1265,"tRNA-Val-GTY":1266,"U17":1267,"(AGTTG)n":1268,"(CAGGT)n":1269,"(CGGAG)n":1270,"(CATGC)n":1271,"(CTAGT)n":1272,"(CTCGG)n":1273,"(CACTG)n":1274,"HY5":1275,"(CCGGG)n":1276,"(ACCTG)n":1277,"(TCTTG)n":1278,"Eulor7":1279,"(CCTAA)n":1280,"(CAAAT)n":1281,"(CAAGG)n":1282,"HERV-Fc1_LTR2":1283,"tRNA-Gln-CAA":1284,"tRNA-Thr-ACA":1285,"tRNA-Arg-CGG":1286,"(CTCCG)n":1287,"(CAAGC)n":1288,"(ATTAG)n":1289,"tRNA-Pro-CCY":1290,"tRNA-Arg-AGG":1291,"(GCATG)n":1292,"(AGTAG)n":1293,"tRNA-Leu-CTG":1294,"(TTAGGC)n":1295,"(CACTT)n":1296,"tRNA-Ser-TCY":1297,"(CCTAG)n":1298,"tRNA-Ser-AGY":1299,"(TCG)n":1300,"(CCGAG)n":1301,"(CGA)n":1302,"(ATTTG)n":1303,"(ACTTG)n":1304,"tRNA-Glu-GAG":1305,"(CAATG)n":1306,"(GCTTG)n":1307,"HERV-Fc2_LTR":1308,"MLT1M-int":1309,"(CCCGAA)n":1310,"tRNA-Leu-TTA":1311,"(TTCG)n":1312,"(CAAGA)n":1313,"(GATTG)n":1314,"tRNA-Ala-GCG":1315,"tRNA-Val-GTA":1316,"(CACGT)n":1317,"(ACGTG)n":1318,"tRNA-Thr-ACY_":1319,"tRNA-Trp-TGG":1320,"tRNA-Thr-ACY":1321,"(CTTAA)n":1322,"tRNA-Thr-ACG_":1323,"(CATTG)n":1324,"(CAGCG)n":1325,"(CTAGG)n":1326,"(CGCTG)n":1327,"(CCGG)n":1328,"(CTAAG)n":1329,"tRNA-Ile-ATC":1330,"(TCCCG)n":1331,"(CAGTT)n":1332,"tRNA-Pro-CCA":1333,"(CAGAC)n":1334,"(TTAGG)n":1335,"(CGGGA)n":1336,"U14":1337,"tRNA-Arg-CGA":1338,"(GCCTAA)n":1339,"tRNA-Ser-TCG":1340,"(GACTG)n":1341,"(CAATC)n":1342,"(TCTCG)n":1343,"(ACTAG)n":1344,"tRNA-Leu-CTA_":1345,"Charlie1b_Mars":1346,"HAL1N1_MD":1347,"(CACGA)n":1348,"(TTAAG)n":1349,"(CTTAG)n":1350,"(CCCTA)n":1351,"(TTACG)n":1352,"(AACTG)n":1353,"(CGAA)n":1354,"(CCGGA)n":1355,"(TCGGG)n":1356,"(CGATA)n":1357,"tRNA-Pro-CCG":1358,"tRNA-Ser-TCA_":1359,"(CATCG)n":1360,"(CGAT)n":1361,"(CGAAA)n":1362,"(CGTAA)n":1363,"tRNA-Tyr-TAT":1364,"(TACGG)n":1365,"tRNA-SeC(e)-TGA":1366,"(CGGAA)n":1367,"(TAGGG)n":1368,"(TCCGG)n":1369,"(ATCG)n":1370,"tRNA-Thr-ACG":1371,"(CCCGA)n":1372,"(TTTCG)n":1373,"(CAAGT)n":1374,"Tigger2a_Car":1375,"(CGAGA)n":1376,"tRNA-Asn-AAT":1377,"(ATCTG)n":1378,"tRNA-Arg-CGA_":1379,"(TTCCG)n":1380,"(ATTCG)n":1381,"(CGGT)n":1382,"(ACCG)n":1383,"(TTCGG)n":1384,"(CCGTA)n":1385,"tRNA-Leu-CTA":1386,"tRNA-Ser-TCA":1387,"CheshMITE":1388,"(CAGAT)n":1389,"tRNA-His-CAY":1390,"(CAACG)n":1391,"(CCGAA)n":1392,"(CGATG)n":1393,"(CTTCG)n":1394,"(CGTTG)n":1395};

Template.Heatmap.onCreated(function () {
    Session.set('heatmapReady', false);
});
/*****************************************************************************/
/* SubfamList: Helpers */
/*****************************************************************************/


Template.Heatmap.onRendered(function () {

    var heatmapConfig = {};

    var margin = {top: 150, right: 10, bottom: 50, left: 300},
        cellSize = 12;
    heatmapConfig['margin'] = margin;
    heatmapConfig['cellSize'] = cellSize;



    var data = []; // Adding this after disabling the previously laid out structure

    var dataRatio = [];
    var datasetNames = [];

    // Pull data from mongo db
    var datasets = Datasets.find({});
    var subfam = Subfam.find({}).fetch();

    var col_number = subfam.length;
    var row_number = datasets.fetch().length;

    width = cellSize * col_number, // - margin.left - margin.right,
    height = cellSize * row_number , // - margin.top - margin.bottom,

    heatmapConfig[ 'col_number' ] = col_number;
    heatmapConfig[ 'row_number' ] = row_number;
    heatmapConfig['width'] = width;
    heatmapConfig['height'] = height;

        //gridSize = Math.floor(width / 24),
    legendElementWidth = cellSize,
    colorBuckets = 9,
        //colors = ['#005824', '#1A693B', '#347B53', '#4F8D6B', '#699F83', '#83B09B', '#9EC2B3', '#B8D4CB', '#D2E6E3', '#EDF8FB', '#FFFFFF', '#F1EEF6', '#E6D3E1', '#DBB9CD', '#D19EB9', '#C684A4', '#BB6990', '#B14F7C', '#A63467', '#9B1A53', '#91003F'];
        // colors = ['#FF0000', '#FF1717', '#FF2E2E', '#FF4545', '#FF5C5C', '#FF7373', '#FF8B8B', '#FFA2A2', '#FFB9B9', '#FFD0D0', '#FFFFFF', '#D0D0FF', '#B9B9FF', '#A2A2FF', '#8B8BFF', '#7373FF', '#5C5CFF', '#4545FF', '#2E2EFF', '#1717FF', '#0000FF'];  // '#FFE7E7', '#FFFFFF', '#E7E7FF'
       
    colors = ['#FF0000', '#FF1717', '#FF2E2E', '#FF4545', '#FF5C5C', '#FF7373', 
                    '#FF8B8B', '#FFA2A2', '#FFB9B9', '#FFD0D0', 
                    '#FFFFFF', '#D0D0FF', '#B9B9FF', '#A2A2FF', '#8B8BFF', '#7373FF', 
                    '#5C5CFF', '#4545FF', '#2E2EFF', '#1717FF', '#0000FF'];  

    colorsBR = ['#0000FF', '#2E2EFF', '#5C5CFF',
                    '#FFFFFF', '#B9B9FF', '#FFA2A2',
                    '#FF0000', '#FF2E2E', '#FF5C5C'
                    ];


    var hcrowStart = 1, hcrowEnd = row_number;
    var hccolStart = 1, hccolEnd = col_number;
    var hcrow = [], hccol = [];

    for (var i = hcrowStart; i <= hcrowEnd; i++) {
        hcrow.push(i);
    }

    heatmapConfig['hcrow'] = hcrow;


    for (var j = hccolStart; j <= hccolEnd; j++) {
        hccol.push(j);
    }
    heatmapConfig['hccol'] = hccol;

    selectedSubfam = [];

    colLabel = [];
    subfam.forEach(function(doc) {
        colLabel.push(doc.name);
        selectedSubfam.push(doc._id);
    });


    rowLabel = [];
    datasets.forEach(function(doc) {
        datasetNames.push(doc.name);
        rowLabel.push(doc.label);
        var tmp = [];

        var arr = doc.ratio_all.split(',');
        selectedSubfam.forEach(function(subfamid){
            tmp.push(parseFloat(arr[subfamid - 1]));
        });
        dataRatio.push(tmp);
        }
    );

    heatmapConfig['rowLabel'] = rowLabel;
    heatmapConfig['datasets'] = datasets;
    heatmapConfig['datasetNames'] = datasetNames;
    heatmapConfig['data'] = data;

    heatmapConfig['colLabel'] = colLabel;

    var forScale = [];

    // parse data ratio - and dump it in data array
    for (var i = 0; i < dataRatio.length; i++) {
        var row = dataRatio[i];
        for (var j = 0; j < col_number; j++) {
            var cellObj = {}; // tmp obj
            cellObj['row'] = i + 1;
            cellObj['col'] = j + 1;
            cellObj['value'] = row[j];

            forScale.push(row[j]);

            data.push(cellObj);
        }
    }  

    RdBu = ["#b2182b","#d6604d","#f4a582","#fddbc7","#f7f7f7","#d1e5f0","#92c5de","#4393c3","#2166ac"];
    BuRd = RdBu.reverse();
    Blues = ["#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#084594"];
    // Blues = ["#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#084594"];
    Reds  = ["#fff5f0","#fee0d2","#fcbba1","#fc9272","#fb6a4a","#ef3b2c","#cb181d","#99000d"];  

    var sizeExtent = d3.extent(forScale);
    var colorDomain = [-4,-3, -2, -1, 0, 1, 2, 3, 4];

    var negExtent = [ sizeExtent[0], 0 ];
    var posExtent = [ 0, (sizeExtent[1]) ]; 


    var negColorScale = d3.scale.quantize()
                 .domain(negExtent).range(Blues.reverse());

    var posColorScale = d3.scale.quantize()
                 .domain(posExtent).range(Reds);

    heatmapConfig['colors'] = BuRd;
    heatmapConfig['negColorScale'] = negColorScale;
    heatmapConfig['posColorScale'] = posColorScale;
    
    var colorScale = d3.scale.quantile()
                .domain([-4, 0, 4])
                .range(RdBu); 

	heatmapConfig['colorScale'] = colorScale;       

    var svg = d3.select("#main").append("svg")
        .attr("width", width + margin.left + margin.right)  // Expanded the drawing canvas
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")")// moved the brush
        ;
    var rowSortOrder = false;
    var colSortOrder = false;


/*========== Row labels ===========*/
    svg = drawRowLabels(svg, heatmapConfig);

/*========== Column labels ===========*/
    // drawColLabels(svg, heatmapConfig);

/* SUBFAMILY METADATA CELLS */
// subFamMetaDataCells()
// assaySampleMetadata()
// drawHeatMap()
// legend()
  
// TODO : Drag and select should give option to zoom on on the selection
// TODO : Pan and zoom, with reset,  on these line - http://bl.ocks.org/mbostock/7ec977c95910dd026812
// TODO : Main wrapper/container should be fluid and responsive

    

/*==================LOAD COMPLETE FLAG===========*/

Session.set('heatmapReady', true) // Place this when load complete

/*========== Change ordering of cells ===========*/

            function sortbylabel(rORc, i, sortOrder) {
                var t = svg.transition().duration(3000);
                var log2r = [];
                var sorted; // sorted is zero-based index
                

                if (rORc == "r") { // sort log2ratio of a gene
                    d3.selectAll(".c" + rORc + i)
                    .filter(function (ce) {
                        log2r.push(ce.value);
                    })
                    ;
                    sorted = d3.range(col_number).sort(function (a, b) {
                        if (sortOrder) {
                            return log2r[b] - log2r[a];
                        } else {
                            return log2r[a] - log2r[b];
                        }
                    });
                    // ** On sorting based on Row Label - CFS metadata heatmap also update
                    t.selectAll(".sfc")
                        .attr("y", function (d, i) {
                            return sorted.indexOf(i) * cellSize;
                        })
                    ;

                    t.selectAll(".sff")
                        .attr("y", function (d, i) {
                            return sorted.indexOf(i) * cellSize;
                        })
                    ;
                    t.selectAll(".sfsf")
                        .attr("y", function (d, i) {
                            return sorted.indexOf(i) * cellSize;
                        })
                    ;

                    // ** Done 

                    t.selectAll(".cell")
                        .attr("x", function (d) {
                            return sorted.indexOf(d.col - 1) * cellSize;
                        })
                    ;
                    t.selectAll(".colLabel")
                        .attr("y", function (d, i) {
                            return sorted.indexOf(i) * cellSize;
                        })
                    ;
                } else if (rORc == "sfClass"){
                    var classNames = i; // hitchhiked array with class names
                    sorted = d3.range(col_number).sort(function (a, b) {
                        if (sortOrder) {
                            return d3.ascending(classNames[a], classNames[b]);
                        } else {
                            return d3.descending(a, b);
                        }
                    });

                    t.selectAll(".sfc")
                        .attr("y", function (d, i) {
                            return sorted.indexOf(i) * cellSize;
                        })
                    ;
                    t.selectAll(".cell")
                        .attr("x", function (d) {
                            return sorted.indexOf(d.col - 1) * cellSize;
                        })
                    ;
                    t.selectAll(".sff")
                        .attr("y", function (d, i) {
                            return sorted.indexOf(i) * cellSize;
                        })
                    ;
                    t.selectAll(".sfsf")
                        .attr("y", function (d, i) {
                            return sorted.indexOf(i) * cellSize;
                        })
                    ;
                    t.selectAll(".colLabel")
                        .attr("y", function (d, i) {
                            return sorted.indexOf(i) * cellSize;
                        })
                    ;

                } else if (rORc == "ySample") {
                    var sampleIDs = i;
                    sorted = d3.range(row_number).sort(function (a, b) {
                        if (sortOrder) {
                            return sampleIDs[b] - sampleIDs[a];
                        } else {
                            return sampleIDs[a] - sampleIDs[b];
                        }
                    });
                    t.selectAll(".ysam")
                        .attr("y", function (d, i) {
                            return sorted.indexOf(i) * cellSize - cellSize;
                        })
                    ;
                    t.selectAll(".yAssay")
                        .attr("y", function (d, i) {
                            return sorted.indexOf(i) * cellSize - cellSize;
                        })
                    ;
                    t.selectAll(".cell")
                        .attr("y", function (d) {
                            return sorted.indexOf(d.row - 1) * cellSize;
                        })
                    ;
                    t.selectAll(".rowLabel")
                        .attr("y", function (d, i) {
                            return sorted.indexOf(i) * cellSize;
                        })
                    ;

                } else if (rORc == "yAssay") {
                    var assayIDs = i;
                    sorted = d3.range(row_number).sort(function (a, b) {
                        if (sortOrder) {
                            return assayIDs[b] - assayIDs[a];
                        } else {
                            return assayIDs[a] - assayIDs[b];
                        }
                    });
                    t.selectAll(".yAssay")
                        .attr("y", function (d, i) {
                            return sorted.indexOf(i) * cellSize - cellSize;
                        })
                    ;
                    t.selectAll(".ysam")
                        .attr("y", function (d, i) {
                            return sorted.indexOf(i) * cellSize - cellSize;
                        })
                    ;
                    t.selectAll(".cell")
                        .attr("y", function (d) {
                            return sorted.indexOf(d.row - 1) * cellSize;
                        })
                    ;
                    t.selectAll(".rowLabel")
                        .attr("y", function (d, i) {
                            return sorted.indexOf(i) * cellSize;
                        })
                    ;
                } else { // sort log2ratio of a contrast
                    d3.selectAll(".c" + rORc + i)
                    .filter(function (ce) {
                        log2r.push(ce.value);
                    })
                    ;
                    sorted = d3.range(row_number).sort(function (a, b) {
                        if (sortOrder) {
                            return log2r[b] - log2r[a];
                        } else {
                            return log2r[a] - log2r[b];
                        }
                    });
                    t.selectAll(".cell")
                        .attr("y", function (d) {
                            return sorted.indexOf(d.row - 1) * cellSize;
                        })
                    ;
                    t.selectAll(".rowLabel")
                        .attr("y", function (d, i) {
                            return sorted.indexOf(i) * cellSize;
                        })
                    ;
                }
            }

            d3.select("#order").on("change", function () {
                order(this.value);
            });

            function order(value) {
                if (value == "hclust") {
                    var t = svg.transition().duration(3000);
                    t.selectAll(".cell")
                        .attr("x", function (d) {
                            return hccol.indexOf(d.col) * cellSize;
                        })
                        .attr("y", function (d) {
                            return hcrow.indexOf(d.row) * cellSize;
                        })
                    ;

                    t.selectAll(".rowLabel")
                        .attr("y", function (d, i) {
                            return hcrow.indexOf(i + 1) * cellSize;
                        })
                    ;

                    t.selectAll(".colLabel")
                        .attr("y", function (d, i) {
                            return hccol.indexOf(i + 1) * cellSize;
                        })
                    ;

                } else if (value == "probecontrast") {
                    var t = svg.transition().duration(3000);
                    t.selectAll(".cell")
                        .attr("x", function (d) {
                            return (d.col - 1) * cellSize;
                        })
                        .attr("y", function (d) {
                            return (d.row - 1) * cellSize;
                        })
                    ;

                    t.selectAll(".rowLabel")
                        .attr("y", function (d, i) {
                            return i * cellSize;
                        })
                    ;

                    t.selectAll(".colLabel")
                        .attr("y", function (d, i) {
                            return i * cellSize;
                        })
                    ;

                } else if (value == "probe") {
                    var t = svg.transition().duration(3000);
                    t.selectAll(".cell")
                        .attr("y", function (d) {
                            return (d.row - 1) * cellSize;
                        })
                    ;

                    t.selectAll(".rowLabel")
                        .attr("y", function (d, i) {
                            return i * cellSize;
                        })
                    ;
                } else if (value == "contrast") {
                    var t = svg.transition().duration(3000);
                    t.selectAll(".cell")
                        .attr("x", function (d) {
                            return (d.col - 1) * cellSize;
                        })
                    ;
                    t.selectAll(".colLabel")
                        .attr("y", function (d, i) {
                            return i * cellSize;
                        })
                    ;
                }
            }

    /*========== g3 class is the body of the heatmap ===========*/

    /*var sa = d3.select(".g3")
        .on("mousedown", function () {
            if (!d3.event.altKey) {
                d3.selectAll(".cell-selected").classed("cell-selected", false);
                d3.selectAll(".rowLabel").classed("text-selected", false);
                d3.selectAll(".colLabel").classed("text-selected", false);
            }
            console.log('clicked on' + event.target);
            /!*.on("click", function (d) {
                var rowtext = d3.select(".r" + (d.row - 1));
                console.log('clicked on' + event.target.value);
                if (rowtext.classed("text-selected") == false) {
                    rowtext.classed("text-selected", true);
                } else {
                    rowtext.classed("text-selected", false);
                }
            })*!/
            var p = d3.mouse(this);
            sa.append("rect")
                .attr({
                    rx: 0,
                    ry: 0,
                    class: "selection",
                    x: p[0],
                    y: p[1],
                    width: 1,
                    height: 1
                })
        })
        .on("mousemove", function () {
            var s = sa.select("rect.selection");

            if (!s.empty()) {
                var p = d3.mouse(this),
                    d = {
                        x: parseInt(s.attr("x"), 10),
                        y: parseInt(s.attr("y"), 10),
                        width: parseInt(s.attr("width"), 10),
                        height: parseInt(s.attr("height"), 10)
                    },
                    move = {
                        x: p[0] - d.x,
                        y: p[1] - d.y
                    }
                    ;

                if (move.x < 1 || (move.x * 2 < d.width)) {
                    d.x = p[0];
                    d.width -= move.x;
                } else {
                    d.width = move.x;
                }

                if (move.y < 1 || (move.y * 2 < d.height)) {
                    d.y = p[1];
                    d.height -= move.y;
                } else {
                    d.height = move.y;
                }
                s.attr(d);

                // deselect all temporary selected state objects
                d3.selectAll('.cell-selection.cell-selected').classed("cell-selected", false);
                d3.selectAll(".text-selection.text-selected").classed("text-selected", false);

                d3.selectAll('.cell').filter(function (cell_d, i) {
                    if (
                        !d3.select(this).classed("cell-selected") &&
                            // inner circle inside selection frame
                        (this.x.baseVal.value) + cellSize >= d.x && (this.x.baseVal.value) <= d.x + d.width &&
                        (this.y.baseVal.value) + cellSize >= d.y && (this.y.baseVal.value) <= d.y + d.height
                    ) {

                        d3.select(this)
                            .classed("cell-selection", true)
                            .classed("cell-selected", true);

                        d3.select(".r" + (cell_d.row - 1))
                            .classed("text-selection", true)
                            .classed("text-selected", true);

                        d3.select(".c" + (cell_d.col - 1))
                            .classed("text-selection", true)
                            .classed("text-selected", true);
                    }
                });
            }
        })
        .on("mouseup", function () {
            // remove selection frame
            sa.selectAll("rect.selection").remove();

            // remove temporary selection marker class
            d3.selectAll('.cell-selection').classed("cell-selection", false);
            d3.selectAll(".text-selection").classed("text-selection", false);
        })
        .on("mouseout", function () {
            if (d3.event.relatedTarget.tagName == 'html') {
                // remove selection frame
                sa.selectAll("rect.selection").remove();
                // remove temporary selection marker class
                d3.selectAll('.cell-selection').classed("cell-selection", false);
                d3.selectAll(".rowLabel").classed("text-selected", false);
                d3.selectAll(".colLabel").classed("text-selected", false);
            }
        });
*/
    
    callGenomeGraph = function(coordinate) {
        Session.set('coordinate', coordinate);
        var subfamClicked = Subfam.findOne({
            name: coordinate[1]
        	});
        // SESSION : set filename string for integration with main browser
        var subfamfile = subfamClicked.subfamclass + subfamClicked.family +subfamClicked.name ;
        Session.set('subfamfile', subfamfile);

        if( subfamClicked.consensuslength === "0"){
        	toastr.options = {
			  "closeButton": false,
			  "debug": false,
			  "newestOnTop": false,
			  "progressBar": false,
			  "positionClass": "toast-bottom-right",
			  "preventDuplicates": true,
			  "onclick": null,
			  "showDuration": "300",
			  "hideDuration": "1000",
			  "timeOut": "5000",
			  "extendedTimeOut": "1000",
			  "showEasing": "swing",
			  "hideEasing": "linear",
			  "showMethod": "fadeIn",
			  "hideMethod": "fadeOut"
			}
        	toastr.error('Cannot load Consensus View: \nconsensus length is 0 ');
        } else {
        	// $.blockUI({ message: null }); 
         	// setTimeout($.unblockUI, 2000 );
        	Router.go('/gg');
        }
    }


    
});

Template.Heatmap.helpers({
    /*'getWidth' : function() {
        var col_number = 60, cellSize = 12, left = 300, right = 10;

        return (cellSize * col_number) + left + right + 100;
    },

    'getHeight' : function() {
        var row_number = 50, cellSize = 12, top = 150, bottom = 50;

        return (cellSize * col_number) + top + bottom + 100;
    }
    ,*/
    browserReady: function () { 
        return Session.get('heatmapReady')
    }

});

Template.Heatmap.onDestroyed(function () {
    Session.set('heatmapReady', false);
});
